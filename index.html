<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Consultant's AI Prompting Toolkit: Dynamic V3</title>
    <style>
        /*
        * Embedded CSS Styling to Mimic a Clean Jekyll Theme (V3)
        */
        :root {
            --color-text: #151515;
            --color-background: #ffffff;
            --color-link: #2a7ae2; /* Primary Action/Link Blue */
            --color-primary: #0056b3; /* Professional Blue */
            --color-accent: #f6f6f6; /* Light gray for blocks */
            --color-success: #38a169; /* Green for success messages */
            --border-radius: 4px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        }

        body {
            font-family: var(--font-stack);
            margin: 0;
            padding: 20px;
            background-color: #fcfcfc;
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--color-background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: var(--color-primary);
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 10px;
            font-weight: 600;
        }

        h2 {
            color: var(--color-primary);
            font-size: 1.5rem;
            margin-top: 20px;
            margin-bottom: 15px;
        }

        h3 {
            color: var(--color-text);
            font-size: 1.2rem;
            margin-top: 20px;
            border-left: 3px solid var(--color-link);
            padding-left: 10px;
            font-weight: 500;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 40px;
            margin-top: 20px;
        }
        
        /* Form Grouping and Inputs */
        .form-group {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }
        
        .form-group fieldset {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
        }

        .form-group legend {
            font-weight: bold;
            color: var(--color-primary);
            padding: 0 10px;
        }
        
        .generator-section label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }

        .generator-section label:hover {
            background-color: var(--color-accent);
        }

        .generator-section input[type="radio"]:checked + span,
        .generator-section input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: var(--color-primary);
        }

        select, input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #c0c0c0;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1rem;
            font-family: inherit;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        /* Output Area and Controls */
        #promptOutput {
            background-color: #f7f7f7;
            border: 1px solid #c0c0c0;
            min-height: 200px;
            font-family: 'Consolas', 'Menlo', monospace;
            white-space: pre-wrap;
            margin-bottom: 5px;
        }

        .output-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #charCount {
            font-size: 0.85rem;
            color: #666;
        }

        .output-controls {
            display: flex;
            gap: 10px;
        }

        .button {
            background-color: var(--color-link);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .button.secondary {
            background-color: #6c757d;
        }

        .button:hover {
            background-color: #1964c8;
        }
        
        .button.secondary:hover {
            background-color: #5a6268;
        }

        /* Toast Notification */
        #toastMessage {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--color-success);
            color: #fff;
            text-align: center;
            border-radius: var(--border-radius);
            padding: 16px;
            position: fixed;
            z-index: 1;
            right: 20px;
            bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }

        #toastMessage.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* Selection Summary */
        #selectionSummary {
            padding: 15px;
            margin-bottom: 20px;
            background-color: #e6f3ff;
            border: 1px solid var(--color-link);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-primary);
        }
        
        /* Preset Controls */
        .preset-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .preset-controls select {
            flex-grow: 1;
            width: auto;
        }

        /* Footer */
        .footer-section {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--color-accent);
            border-radius: var(--border-radius);
            border-top: 1px solid #e0e0e0;
        }
        
        .footer-section h3 {
            border-left: none;
            padding-left: 0;
            color: var(--color-primary);
            font-size: 1.1rem;
            margin-top: 10px;
        }
        
        .disclaimer p, .attribution p {
            font-size: 0.85rem;
            color: #555;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .layout-grid {
                grid-template-columns: 1fr;
            }
            .guide-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding-right: 0;
                padding-bottom: 20px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>The Consultant's AI Prompting Toolkit: Dynamic Guide (V3)</h1>
        
        <!-- Preset Controls -->
        <h2>Prompt Preset Library</h2>
        <div class="preset-controls">
            <select id="presetSelector" onchange="loadPreset(this.value)">
                <option value="">-- Load a Saved Prompt Preset --</option>
            </select>
            <button class="button secondary" onclick="savePreset()">Save Current</button>
            <button class="button secondary" onclick="deletePreset()">Delete Selected</button>
        </div>
        
        <div class="layout-grid">
            
            <!-- Educational Guide Section -->
            <div class="guide-section">
                <h2>The P-O-C-E Framework</h2>
                <p>Define the **Persona (P)**, state the **Objective (O)**, apply **Context (C)**, and provide **Input/Example (E)**.</p>

                <h3>P: Persona/Role</h3>
                <h3>O: Objective/Task</h3>
                <h3>C: Context/Constraints</h3>
                <h3>E: Example/Input</h3>
            </div>

            <!-- Interactive Prompt Generator -->
            <div class="generator-section">
                <h2>Interactive Prompt Generator Controls</h2>
                <button class="button secondary" style="margin-bottom: 20px;" onclick="resetGenerator()">Reset All Selections</button>

                <div class="form-group">
                    <h3>1. Persona/Role (P)</h3>
                    <p>Selecting a persona dynamically updates all other options for maximum relevance.</p>
                    <label><input type="radio" name="persona" data-persona="Chartered Accountant" onchange="updateOptions('Chartered Accountant')" value="Act as a highly experienced Chartered Accountant with deep regulatory knowledge."> <span>Chartered Accountant</span></label>
                    <label><input type="radio" name="persona" data-persona="Corporate Legal Counsel" onchange="updateOptions('Corporate Legal Counsel')" value="Act as a Corporate Legal Counsel specializing in risk mitigation and contract law."> <span>Corporate Legal Counsel (New)</span></label>
                    <label><input type="radio" name="persona" data-persona="Data Science Analyst" onchange="updateOptions('Data Science Analyst')" value="Act as a seasoned Data Science Analyst fluent in Python, R, and statistical modeling."> <span>Data Science Analyst (New)</span></label>
                    <label><input type="radio" name="persona" data-persona="Marketing Strategist" onchange="updateOptions('Marketing Strategist')" value="Act as a creative Marketing Strategist specializing in B2B services."> <span>Marketing Strategist</span></label>
                    <label><input type="radio" name="persona" data-persona="Expert Educator" onchange="updateOptions('Expert Educator')" value="Act as an expert educator, capable of explaining complex topics simply using analogies."> <span>Expert Educator</span></label>
                </div>

                <div class="form-group">
                    <h3>2. Core Objective (O)</h3>
                    <select id="objective" onchange="generatePrompt()">
                        <option value="">-- Select a primary action (changes based on P) --</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <h3>3. Advanced Tone/Style (O/C)</h3>
                    <fieldset id="toneOptions">
                        <legend>Select Output Style/Format (changes based on P)</legend>
                        <!-- Options populated by JavaScript -->
                        <p style="color:#888; margin-top: 5px;">Select a Persona above to load specific Tone options.</p>
                    </fieldset>
                </div>

                <div class="form-group">
                    <h3>4. Context & Constraints (C)</h3>
                    <fieldset id="constraintOptions">
                        <legend>Select Rules & Limits (changes based on P)</legend>
                        <!-- Options populated by JavaScript -->
                        <p style="color:#888; margin-top: 5px;">Select a Persona above to load specific Constraint options.</p>
                    </fieldset>
                </div>

                <div class="form-group">
                    <h3>5. External URL (E)</h3>
                    <input type="text" id="externalUrl" placeholder="Paste single URL (e.g., news article, notification) for AI to analyze." onkeyup="generatePrompt()">
                </div>
                
                <div class="form-group">
                    <h3>6. Optional Input/Data (E)</h3>
                    <textarea id="inputData" placeholder="Paste relevant data, brief, or example text here (e.g., a client email, a regulation text, a data list)." onkeyup="generatePrompt()"></textarea>
                </div>

            </div>
        </div>
        
        <!-- Output Area -->
        <hr style="margin-top: 30px;">
        <h2>Generated Draft Prompt</h2>
        
        <div id="selectionSummary">Please select a **Persona** to begin configuring your prompt.</div>

        <textarea id="promptOutput" readonly placeholder="Your custom prompt will appear here as you make selections."></textarea>
        
        <div class="output-footer">
            <div id="charCount">0 characters</div>
            <div class="output-controls">
                <button class="button" onclick="copyPrompt()">Copy Prompt</button>
                <button class="button secondary" onclick="downloadPrompt()">Download (.txt)</button>
            </div>
        </div>
        
        <!-- Toast Notification Container -->
        <div id="toastMessage"></div>

        <!-- Disclaimer and Attribution Section -->
        <div class="footer-section">
            <div class="disclaimer">
                <h3>Disclaimer</h3>
                <p>This tool is provided for **informational and educational purposes only**. It does not constitute, and should not be relied upon as, **professional accounting, legal, tax, financial, or other advisory services**. No responsibility is accepted for any loss or damage arising from the use or reliance on the information provided by this tool. By using this tool, you acknowledge and agree to these terms.</p>
            </div>
            <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 15px 0;">
            <div class="attribution">
                <h3>Attribution and Connection</h3>
                <p>Tool Created By:<br>
                <strong>Tanmay Rajendra Bhavar, Chartered Accountant and Founder of TRB & Co.</strong></p>
                <p>Let's Connect:<br>
                For personalized professional advice regarding your business, tax planning, or consultancy needs, please connect with me directly on LinkedIn. We look forward to partnering with you.</p>
            </div>
        </div>

    </div>

    <script>
        /*
        * Embedded JavaScript for Dynamic Prompt Generation and Utility Features (V3)
        */
        const outputElement = document.getElementById('promptOutput');
        const inputDataElement = document.getElementById('inputData');
        const objectiveSelect = document.getElementById('objective');
        const presetSelector = document.getElementById('presetSelector');
        const toneOptionsContainer = document.getElementById('toneOptions');
        const constraintOptionsContainer = document.getElementById('constraintOptions');

        // --- Dynamic Content Data Structure ---
        const personaOptions = {
            'Chartered Accountant': {
                objectives: [
                    { value: "Draft a comprehensive advisory memo analyzing the tax implications of the input data.", text: "Draft a Tax Memo/Advisory" },
                    { value: "Summarize the key compliance requirements and risks from the attached audit report or regulation text.", text: "Summarize Audit & Compliance Report" },
                    { value: "Calculate the estimated tax liability for the client described in the input data.", text: "Calculate Estimated Tax Liability" },
                ],
                constraints: [
                    { value: "Strictly adhere to (Indian) Tax Law and recent amendments.", text: "Adhere to specific Tax Law" },
                    { value: "Reference the relevant section numbers for all statutory citations.", text: "Cite Statute Sections" },
                    { value: "Use only financial ratios provided in the input data for analysis.", text: "Use only Input Ratios" },
                ],
                tones: [
                    { value: "Ensure the response is presented in a formal, Advisory/Consultative tone.", text: "Advisory Tone" },
                    { value: "Use technical terminology appropriate for a regulatory filing.", text: "Regulatory/Technical Tone" },
                    { value: "Simplify the explanation for a client with no financial background.", text: "Simplified Client-Ready Explanation" },
                ]
            },
            'Corporate Legal Counsel': {
                objectives: [
                    { value: "Analyze the attached contract draft for liability exposure and recommend revisions in markdown format.", text: "Analyze Contract for Risk & Revisions" },
                    { value: "Explain the legal standing of [topic] based on the input document to a non-legal executive.", text: "Explain Legal Standing (Executive)" },
                    { value: "Outline the necessary steps for a new regulatory filing.", text: "Outline Regulatory Filing Steps" },
                ],
                constraints: [
                    { value: "Identify and list all potential contractual ambiguity.", text: "List Ambiguities" },
                    { value: "Limit the summary of findings to 3-5 bullet points.", text: "Limit to 5 Key Points" },
                    { value: "Exclude all jargon and use plain English only.", text: "Use Plain English Only" },
                ],
                tones: [
                    { value: "The tone must be cautious and risk-averse.", text: "Risk-Averse/Cautious Tone" },
                    { value: "Use formal, academic language suitable for a legal brief.", text: "Legal Brief Style" },
                ]
            },
            'Data Science Analyst': {
                objectives: [
                    { value: "Write a complete, executable Python script to clean and visualize the attached dataset.", text: "Write Python Script (Clean & Visualize)" },
                    { value: "Draft a SQL query to extract [specific metric] from the provided database schema.", text: "Draft SQL Query" },
                    { value: "Perform a statistical summary and outline 5 key data insights.", text: "Perform Statistical Summary" },
                ],
                constraints: [
                    { value: "The entire response must be enclosed in a markdown code block.", text: "Output must be Code Block" },
                    { value: "Ensure all Python code uses the Pandas library and is fully commented.", text: "Use Pandas and Comment Heavily" },
                    { value: "Focus the analysis specifically on time-series trends.", text: "Focus on Time-Series Trends" },
                ],
                tones: [
                    { value: "Use precise, technical language suitable for a peer review.", text: "Technical/Peer Review Tone" },
                    { value: "Focus on clear, step-by-step methodology.", text: "Methodology-Focused Tone" },
                ]
            },
            'Marketing Strategist': {
                objectives: [
                    { value: "Draft 5 LinkedIn posts based on the input brief, targeting CEOs.", text: "Draft LinkedIn Posts" },
                    { value: "Develop a content strategy outline for the next quarter.", text: "Develop Content Strategy Outline" },
                    { value: "Summarize a competitor's strategy and suggest 3 counter-moves.", text: "Summarize Competitor Strategy" },
                ],
                constraints: [
                    { value: "Adopt a brand voice that is energetic, authoritative, and uses emojis.", text: "Energetic and Authoritative Brand Voice" },
                    { value: "Ensure all posts are optimized for a 90-second read time.", text: "Optimize for Fast Reading" },
                    { value: "The content must focus exclusively on B2B professional services.", text: "B2B Focus" },
                ],
                tones: [
                    { value: "Use a motivational and persuasive tone.", text: "Persuasive/Motivational Tone" },
                    { value: "Maintain a light, humorous, and conversational style.", text: "Light/Conversational Style" },
                ]
            },
            'Expert Educator': {
                objectives: [
                    { value: "Explain the principle of [topic] to a fifth-grade student.", text: "Explain to a Fifth Grader" },
                    { value: "Develop 10 multiple-choice questions on the attached document.", text: "Develop 10 Multiple-Choice Questions" },
                    { value: "Create a metaphor or analogy to simplify the core concept of [topic].", text: "Create Simplifying Analogy" },
                ],
                constraints: [
                    { value: "Ensure the explanation avoids jargon and complex sentences entirely.", text: "No Jargon, Simple Sentences" },
                    { value: "Structure the output as a 4-part lesson plan.", text: "Structure as 4-Part Lesson Plan" },
                    { value: "The tone must be encouraging and highly accessible.", text: "Encouraging and Accessible Tone" },
                ],
                tones: [
                    { value: "Use a clear, structured, academic explanation.", text: "Structured Academic Tone" },
                    { value: "Use an encouraging, supportive, and narrative style.", text: "Narrative/Supportive Tone" },
                ]
            },
        };


        // --- Dynamic Option Loader (New Core Function) ---
        function updateOptions(persona) {
            const opts = personaOptions[persona];
            
            // 1. Clear and Populate Objective Dropdown
            objectiveSelect.innerHTML = `<option value="">-- Select a primary action for ${persona} --</option>`;
            if (opts && opts.objectives) {
                opts.objectives.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.text;
                    objectiveSelect.appendChild(option);
                });
            }

            // 2. Clear and Populate Tone Fieldset
            toneOptionsContainer.innerHTML = `<legend>Select Output Style/Format</legend>`;
            if (opts && opts.tones) {
                opts.tones.forEach((item, index) => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="radio" name="tone" value="${item.value}" onchange="generatePrompt()"> <span>${item.text}</span>`;
                    toneOptionsContainer.appendChild(label);
                });
            } else {
                toneOptionsContainer.innerHTML = `<p style="color:#888; margin-top: 5px;">No Tone options available for this persona.</p>`;
            }

            // 3. Clear and Populate Constraint Fieldset
            constraintOptionsContainer.innerHTML = `<legend>Select Rules & Limits</legend>`;
            if (opts && opts.constraints) {
                 const fieldset = document.createElement('fieldset');
                 fieldset.innerHTML = `<legend>Persona-Specific Constraints</legend>`;
                 
                 opts.constraints.forEach((item, index) => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" name="constraint" value="${item.value}" onchange="generatePrompt()"> <span>${item.text}</span>`;
                    fieldset.appendChild(label);
                });
                constraintOptionsContainer.appendChild(fieldset);
            } else {
                constraintOptionsContainer.innerHTML = `<p style="color:#888; margin-top: 5px;">No Constraint options available for this persona.</p>`;
            }

            // Ensure the generator runs to update the summary and prompt output
            generatePrompt();
        }
        
        // --- Core Prompt Generation Logic ---
        function generatePrompt() {
            let promptParts = [];
            let summaryParts = [];
            let inputPlaceholderText = "Paste relevant data, brief, or example text here...";
            
            // 1. Persona (P)
            const personaRadio = document.querySelector('input[name="persona"]:checked');
            const currentPersonaKey = personaRadio ? personaRadio.getAttribute('data-persona') : null;
            
            if (personaRadio) {
                promptParts.push(personaRadio.value);
                summaryParts.push(`P: ${currentPersonaKey}`);
            }

            // 2. Objective (O)
            if (objectiveSelect.value) {
                const objectiveText = objectiveSelect.options[objectiveSelect.selectedIndex].text;
                promptParts.push("Your core task is to: " + objectiveSelect.value);
                summaryParts.push(`O: ${objectiveText}`);
                
                // Context-Sensitive Placeholder Logic
                if (objectiveText.includes("data") || objectiveText.includes("table") || objectiveText.includes("script")) {
                    inputPlaceholderText = "Paste raw data, structured lists, or database schemas here.";
                } else if (objectiveText.includes("Summarize") || objectiveText.includes("Analyze")) {
                    inputPlaceholderText = "Paste the document, contract, or long text you need the AI to summarize/analyze.";
                }
            }
            inputDataElement.placeholder = inputPlaceholderText;

            // 3. Advanced Tone/Style (C)
            const toneRadio = document.querySelector('input[name="tone"]:checked');
            if (toneRadio) {
                promptParts.push(toneRadio.value);
                summaryParts.push(`Style: ${toneRadio.nextElementSibling.textContent}`);
            }

            // 4. Context & Constraints (C)
            const constraints = document.querySelectorAll('input[name="constraint"]:checked');
            if (constraints.length > 0) {
                let constraintList = "Constraints and style rules:\n";
                constraints.forEach(checkbox => {
                    constraintList += `- ${checkbox.value}\n`;
                });
                promptParts.push(constraintList.trim());
                summaryParts.push(`C: ${constraints.length} Rule(s)`);
            }
            
            // 5. External URL (E)
            const externalUrl = document.getElementById('externalUrl').value.trim();
            if (externalUrl.length > 0) {
                promptParts.push(`\n[EXTERNAL INPUT]\nAnalyze the content found at this URL: ${externalUrl}`);
                summaryParts.push(`URL: Included`);
            }

            // 6. Input Data (E)
            const inputData = inputDataElement.value.trim();
            if (inputData.length > 0) {
                promptParts.push("The following is the specific input, brief, or data you must operate on. Do not start the task until you have processed this:\n---\n" + inputData + "\n---");
                summaryParts.push(`E: Data Included`);
            }
            
            // Assemble the final prompt, separated by double newlines for clarity
            const finalPrompt = promptParts.join("\n\n");

            // Update Output
            outputElement.value = finalPrompt || "Your custom prompt will appear here as you make selections.";
            
            // Character Counter
            document.getElementById('charCount').textContent = `${outputElement.value.length} characters`;

            // Real-Time Selection Summary
            const summaryElement = document.getElementById('selectionSummary');
            const summaryText = summaryParts.length > 0 ? summaryParts.join(" | ") : "Please select a **Persona** to begin configuring your prompt.";
            summaryElement.innerHTML = summaryText; // Use innerHTML to allow for bolding if needed
        }

        // --- Utility Functions ---

        function showToast(message) {
            const toast = document.getElementById('toastMessage');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function(){ 
                toast.classList.remove('show'); 
            }, 3000);
        }

        function copyPrompt() {
            if (outputElement.value && outputElement.value !== "Your custom prompt will appear here as you make selections.") {
                outputElement.select();
                outputElement.setSelectionRange(0, 99999); 
                
                try {
                    document.execCommand('copy');
                    showToast("Prompt Copied to Clipboard!");
                } catch (err) {
                    showToast("Could not copy prompt.");
                }

            } else {
                showToast("Please generate a prompt before copying.");
            }
        }
        
        function resetGenerator() {
            // Reset radio buttons
            document.querySelectorAll('input[type="radio"]:checked').forEach(radio => radio.checked = false);
            // Reset select dropdown
            objectiveSelect.value = "";
            // Reset text areas/inputs
            inputDataElement.value = "";
            document.getElementById('externalUrl').value = "";
            
            // Re-run update options to clear dynamically loaded content
            updateOptions(null); 

            showToast("Generator settings cleared.");
            generatePrompt();
        }
        
        function downloadPrompt() {
            const promptContent = outputElement.value;
            if (!promptContent || promptContent === "Your custom prompt will appear here as you make selections.") {
                showToast("Nothing to download yet!");
                return;
            }

            const filename = 'consultant_prompt_' + new Date().toISOString().slice(0, 10) + '.txt';
            const blob = new Blob([promptContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Downloaded: ${filename}`);
        }

        // --- Preset Library Functions ---
        
        function getPresets() {
            try {
                const presetsJson = localStorage.getItem('trb_prompt_presets');
                return presetsJson ? JSON.parse(presetsJson) : {};
            } catch (e) {
                console.error("Could not load presets from localStorage:", e);
                return {};
            }
        }

        function savePresets(presets) {
            try {
                localStorage.setItem('trb_prompt_presets', JSON.stringify(presets));
            } catch (e) {
                console.error("Could not save presets to localStorage:", e);
            }
        }

        function renderPresetSelector() {
            const presets = getPresets();
            presetSelector.innerHTML = '<option value="">-- Load a Saved Prompt Preset --</option>';

            for (const key in presets) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                presetSelector.appendChild(option);
            }
        }
        
        function savePreset() {
            const presetName = prompt("Enter a name for this prompt preset (e.g., 'Tax Summary Request'):");
            if (!presetName) return;

            const presets = getPresets();
            const config = {
                personaKey: document.querySelector('input[name="persona"]:checked')?.getAttribute('data-persona') || '',
                personaValue: document.querySelector('input[name="persona"]:checked')?.value || '',
                objective: objectiveSelect.value || '',
                tone: document.querySelector('input[name="tone"]:checked')?.value || '',
                constraints: Array.from(document.querySelectorAll('input[name="constraint"]:checked')).map(cb => cb.value),
                externalUrl: document.getElementById('externalUrl').value,
                inputData: inputDataElement.value,
            };

            presets[presetName] = config;
            savePresets(presets);
            renderPresetSelector();
            showToast(`Preset "${presetName}" saved!`);
        }
        
        function loadPreset(name) {
            if (!name) return;

            const presets = getPresets();
            const config = presets[name];

            if (config) {
                // 1. Reset everything
                resetGenerator(); 
                
                // 2. Apply Persona first, which dynamically loads other options
                const personaInput = document.querySelector(`input[name="persona"][data-persona="${config.personaKey}"]`);
                if (personaInput) {
                    personaInput.checked = true;
                    // Crucial: Call updateOptions to load the correct dynamic fields
                    updateOptions(config.personaKey); 
                }
                
                // 3. Apply Objective (now that options are loaded)
                objectiveSelect.value = config.objective;
                
                // 4. Apply Tone (now that options are loaded)
                const toneInput = document.querySelector(`input[name="tone"][value="${config.tone}"]`);
                if (toneInput) {
                    toneInput.checked = true;
                }

                // 5. Apply Constraints (now that options are loaded)
                config.constraints.forEach(value => {
                    const cb = document.querySelector(`input[name="constraint"][value="${value}"]`);
                    if (cb) cb.checked = true; // Fix: use explicit check
                });

                // 6. Apply Text Inputs
                document.getElementById('externalUrl').value = config.externalUrl;
                inputDataElement.value = config.inputData;

                generatePrompt();
                showToast(`Preset "${name}" loaded successfully.`);
            }
        }
        
        function deletePreset() {
            const name = presetSelector.value;
            if (!name) {
                showToast("Please select a preset to delete.");
                return;
            }

            if (confirm(`Are you sure you want to delete the preset "${name}"?`)) {
                const presets = getPresets();
                delete presets[name];
                savePresets(presets);
                renderPresetSelector();
                resetGenerator();
                showToast(`Preset "${name}" deleted.`);
            }
        }


        // Initialization on Load
        window.onload = function() {
            renderPresetSelector(); // Load and display saved presets
            
            // Initial state: If no persona selected, clear options.
            const initialPersona = document.querySelector('input[name="persona"]:checked');
            if (initialPersona) {
                 updateOptions(initialPersona.getAttribute('data-persona'));
            } else {
                 updateOptions(null);
            }
            generatePrompt(); 
        }; 
    </script>
</body>
</html>
